<!-- index.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Điều khiển I/O</title>
  <style>
  body{
    font-family: sans-serif;
    background: #f4f7fb;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 20px; /* chữ to hơn */
  }

  h1 {
    color: #222;
    font-size: 28px;
    margin-bottom: 20px;
  }

  .grid {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .card {
    background: white;
    padding: 24px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    width: 360px;
    text-align: center;
  }

  .controls button {
    margin: 8px;
    padding: 18px 24px;
    font-size: 22px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }
  .controls button:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }

  .open  { background: #28a745; }
  .stop  { background: #ffc107; color: #222; }
  .close { background: #dc3545; }
  .on    { background: #3BCA02; }
  .off   { background: #6c757d; }

  input[type=number] {
    width: 100px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 18px;
    text-align: center;
  }

  /* Trạng thái hiển thị */
  .status {
    margin-top: 12px;
    font-size: 18px;
    font-weight: bold;
  }
  .status.on  { color: #28a745; }  /* BẬT -> xanh lá */
  .status.off { color: #6c757d; }  /* TẮT -> xám */
  .status.timer { font-weight: normal; font-size: 16px; color: #555; }

  .top-right {
    position: fixed;
    right: 18px;
    top: 12px;
  }

  .logout {
    background: #dc3545;
    color: #fff;
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 18px;
  }
</style>
</head>
<body>
  <div class="top-right"><a class="logout" href="/logout">Đăng xuất</a></div>
  <h1>Điều khiển I/O</h1>

  <div class="grid">
    <!-- ESP1 Cửa Cuốn -->
    <div class="card">
      <h3>ESP1</h3>
      <div class="controls">
        <button class="open" onclick="sendCmd('esp1','OPEN')">MỞ</button>
        <button class="stop" onclick="sendCmd('esp1','STOP')">DỪNG</button>
        <button class="close" onclick="sendCmd('esp1','CLOSE')">ĐÓNG</button>
      </div>
      <div class="status" id="esp1-status">Trạng thái: -</div>
    </div>

    <!-- ESP2 -->
    <div class="card">
      <h3>ESP2 - Bình Nóng Lạnh</h3>
      <div>
        <strong>Tầng 1</strong><br/>
        <button class="on" onclick="sendCmd('esp2','ON1')">BẬT</button>
        <button class="off" onclick="sendCmd('esp2','OFF1')">TẮT</button>
        <input id="time1" type="number" min="1" placeholder="phút">
        <button onclick="setTimer(1)">Cập nhật</button>
        <div id="state1" class="status">Trạng thái: -</div>
      </div>
      <hr/>
      <div>
        <strong>Tầng 2</strong><br/>
        <button class="on" onclick="sendCmd('esp2','ON2')">BẬT</button>
        <button class="off" onclick="sendCmd('esp2','OFF2')">TẮT</button>
        <input id="time2" type="number" min="1" placeholder="phút">
        <button onclick="setTimer(2)">Cập nhật</button>
        <div id="state2" class="status">Trạng thái: -</div>
      </div>
    </div>
  </div>

  <script>
    async function sendCmd(device, cmd) {
      const res = await fetch('/action/' + device + '/' + encodeURIComponent(cmd), { method:'POST' });
      if (!res.ok) {
        alert('Lỗi: ' + res.status);
      } else {
        console.log('sent', device, cmd);
      }
    }

    async function setTimer(n) {
      const v = document.getElementById('time' + n).value;
      if (!v || v <= 0) { alert('Nhập phút hợp lệ'); return; }
      // timer command format: TIMER<n>:<minutes>  (ESP will parse)
      await sendCmd('esp2', 'TIMER' + n + ':' + v);
    }

    async function updateUI() {
      try {
        // esp1
        const r1 = await fetch('/status/esp1'); const j1 = await r1.json();
        document.getElementById('esp1-status').innerText = 'Trạng thái: ' + JSON.stringify(j1.io) + (j1.online ? ' (online)' : ' (offline)');
        // esp2
        const r2 = await fetch('/status/esp2'); const j2 = await r2.json();
        if (j2.io) {
          const dev1 = j2.io.dev1 ? 'BẬT' : 'TẮT';
          const dev2 = j2.io.dev2 ? 'BẬT' : 'TẮT';
          const t1 = j2.io.t1 !== undefined ? j2.io.t1 : '-';
          const t2 = j2.io.t2 !== undefined ? j2.io.t2 : '-';
          document.getElementById('state1').innerHTML =
            `<span class="status ${j2.io.dev1 ? 'on' : 'off'}">
               Trạng thái: ${j2.io.dev1 ? 'BẬT' : 'TẮT'}
             </span><div class="status timer">Còn ${t1}p</div>`;
      
          document.getElementById('state2').innerHTML =
            `<span class="status ${j2.io.dev2 ? 'on' : 'off'}">
               Trạng thái: ${j2.io.dev2 ? 'BẬT' : 'TẮT'}
             </span><div class="status timer">Còn ${t2}p</div>`;
        }
      } catch (e) {
        console.error(e);
      }
    }
    

    setInterval(updateUI, 5000);
    updateUI();
  </script>
</body>
</html>
